@page "/register"
@using TodoApp.Services
@using TodoApp.Models
@inject AuthService AuthService
@inject TodoApiService TodoService
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<div class="container" style="max-width: 400px; margin-top: 100px;">
    <h2>Register</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="mb-3">
        <label class="form-label">Full Name</label>
        <input type="text" class="form-control" @bind="fullName" />
    </div>

    <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" @bind="email" />
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" class="form-control" @bind="password" />
    </div>

    <button class="btn btn-success w-100" @onclick="HandleRegister" disabled="@isLoading">
        @if (isLoading)
        {
            <span>Registering...</span>
        }
        else
        {
            <span>Register</span>
        }
    </button>

    <p class="mt-3 text-center">
        Already have an account? <a href="/login">Login here</a>
    </p>
</div>

@code {
    private string fullName = "";
    private string email = "";
    private string password = "";
    private string? errorMessage;
    private bool isLoading = false;

    private async Task HandleRegister()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            if (string.IsNullOrEmpty(fullName) || string.IsNullOrEmpty(email) || string.IsNullOrEmpty(password))
            {
                errorMessage = "All fields are required";
                return;
            }

            var response = await AuthService.RegisterAsync(email, password, fullName);

            if (response == null)
            {
                errorMessage = "Registration failed. Email might already be in use.";
                return;
            }

            // Store token and set in TodoService
            TodoService.SetAuthToken(response.Token);
            AuthState.SetAuthenticated(response.Email, response.Token);

            // Redirect to home page
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}


