@page "/todos"
@using TodoApp.Models
@using TodoApp.Services
@using Microsoft.AspNetCore.Components.Web
@inject TodoApiService TodoApi
@inject HttpClient Http

<PageTitle>My Todos</PageTitle>

<h1>üìù My Todo List</h1>

@if (isLoading)
{
    <p><em>Loading todos...</em></p>
}
else
{
    <div class="add-todo">
        <input @bind="newTodoTitle" 
               @bind:event="oninput"
               placeholder="Enter new todo..." 
               class="todo-input" 
               @onkeypress="HandleKeyPress" />
        <button @onclick="AddTodo" 
                @onclick:preventDefault="false"
                type="button"
                class="btn-add">‚ûï Add</button>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="todo-list">
        @foreach (var todo in todos)
        {
            <div class="todo-item @(todo.IsCompleted ? "completed" : "")">
                <input type="checkbox" checked="@todo.IsCompleted" @onchange="() => ToggleTodo(todo)" />
                <div class="todo-content">
                    <strong>@todo.Title</strong>
                    @if (!string.IsNullOrEmpty(todo.Description))
                    {
                        <p>@todo.Description</p>
                    }
                    <small>Created: @todo.CreatedAt.ToString("MMM dd, yyyy")</small>
                </div>
                <button @onclick="() => DeleteTodo(todo.Id)" class="btn-delete">üóëÔ∏è</button>
            </div>
        }
    </div>

    @if (todos.Count == 0)
    {
        <p class="empty-state">üéâ No todos yet! Add one above to get started.</p>
    }
}

@code {
    private List<TodoItem> todos = new();
    private string newTodoTitle = string.Empty;
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    private async Task LoadTodos()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            todos = await TodoApi.GetTodosAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load todos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AddTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle))
            return;

        try
        {
            errorMessage = null;
            var newTodo = new TodoItem
            {
                Title = newTodoTitle,
                IsCompleted = false,
                CreatedAt = DateTime.UtcNow
            };

            var created = await TodoApi.CreateTodoAsync(newTodo);
            if (created != null)
            {
                todos.Add(created);
                newTodoTitle = string.Empty;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to add todo: {ex.Message}";
        }
    }

    private async Task ToggleTodo(TodoItem todo)
    {
        try
        {
            todo.IsCompleted = !todo.IsCompleted;
            todo.CompletedAt = todo.IsCompleted ? DateTime.UtcNow : null;
            await TodoApi.UpdateTodoAsync(todo.Id, todo);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to update todo: {ex.Message}";
            todo.IsCompleted = !todo.IsCompleted; // Revert on error
        }
    }

    private async Task DeleteTodo(int id)
    {
        try
        {
            await TodoApi.DeleteTodoAsync(id);
            todos.RemoveAll(t => t.Id == id);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete todo: {ex.Message}";
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTodo();
        }
    }
}

<style>
    .add-todo {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .todo-input {
        flex: 1;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    .btn-add {
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-add:hover {
        background: #45a049;
    }

    .todo-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        transition: all 0.3s;
    }

    .todo-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .todo-item.completed {
        opacity: 0.6;
        background: #f0f0f0;
    }

    .todo-item.completed .todo-content strong {
        text-decoration: line-through;
    }

    .todo-content {
        flex: 1;
    }

    .todo-content p {
        margin: 5px 0;
        color: #666;
    }

    .todo-content small {
        color: #999;
    }

    .btn-delete {
        background: #f44336;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-delete:hover {
        background: #da190b;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 18px;
    }

    .alert {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
    }

    .alert-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
