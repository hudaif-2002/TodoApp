@page "/login"
@using TodoApp.Services
@using TodoApp.Models
@inject AuthService AuthService
@inject TodoApiService TodoService
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<div class="container" style="max-width: 400px; margin-top: 100px;">
    <h2>Login</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="mb-3">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" @bind="email" />
    </div>

    <div class="mb-3">
        <label class="form-label">Password</label>
        <input type="password" class="form-control" @bind="password" />
    </div>

    <button class="btn btn-primary w-100" @onclick="HandleLogin" disabled="@isLoading">
        @if (isLoading)
        {
            <span>Logging in...</span>
        }
        else
        {
            <span>Login</span>
        }
    </button>

    <p class="mt-3 text-center">
        Don't have an account? <a href="/register">Register here</a>
    </p>
</div>

@code {
    private string email = "hudaif";
    private string password = "1234";
    private string? errorMessage;
    private bool isLoading = false;

    private async Task HandleLogin()
    {
        errorMessage = null;
        isLoading = true;

        try
        {
            var response = await AuthService.LoginAsync(email, password);

            if (response == null)
            {
                errorMessage = "Invalid email or password";
                return;
            }

            // Store token and set in TodoService
            TodoService.SetAuthToken(response.Token);
            AuthState.SetAuthenticated(response.Email, response.Token);

            // Redirect to home page
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}


